Да — можно и **нужно**: делаем **manual‑first** систему c **опциональной интеграцией с центральными банками** (по региону), причём **любой предложенный курс пользователь может отредактировать** перед сохранением операции/погашения. Ниже — обновление ТЗ (**v1.4**) специально под ваш запрос: «Выбрал регион Узбекистан → подтянулся официальный курс ЦБ → при необходимости я его меняю → в запись попадает именно мой окончательный курс».

---

# LEORA · ТЗ v1.4 · Manual‑first + Official FX (с редактированием)

## 0) Принцип

* **Manual — источник истины.** Все расчёты можно провести **только вручную**.
* **Official FX — удобная подсказка.** Если сеть доступна и интеграция включена, мы **подставляем** «официальный текущий курс» для выбранного региона (например, ЦБ Узбекистана), но **не используем его автоматически** без подтверждения пользователя.
* **Snapshot навсегда.** В каждую запись (расход/приход/IOU/обмен) сохраняем **снимок курса**: откуда взяли, какой был предложен, что пользователь утвердил/исправил.

---

## 1) Источники курсов (Rate Providers)

Абстракция `RateProvider` с приоритетами:

1. **Locked/Frozen** (замороженный курс проекта/периода) — если включён.
2. **Manual** (введён пользователем) — всегда доступен.
3. **Official** (региональный ЦБ) — опционально, как «предложение».
4. **MonthlyAvg** (ручные средние по месяцам) — для отчётных расчётов.
5. **LastUsed** (последний курс для пары) — офлайн‑резерв.

**Mapping по региону** (пример):
`UZ → provider_id='official_central_bank_uz'`, `RU → 'official_cbr'`, `KZ → 'official_nbk'`, `TR → 'official_tcmb'`, `SA → 'official_sama'`, `AE → 'official_cbuae'`.
В настройках Workspace/Project можно **включить/выключить** официальный источник и менять приоритеты.

---

## 2) RateBook 2.0 (локальный справочник курсов)

Записи храним локально, даже для предложений от официального источника:

```
RateBookRow {
  pair: "UZS/USD",                // ориентация пары явная: СКОЛЬКО UZS за 1 USD
  source: 'manual'|'official'|'monthly_avg'|'frozen'|'last_used',
  provider_id?: 'official_central_bank_uz',
  rate_dec: DECIMAL(TEXT),
  as_of: datetime (локаль региона),
  editable: boolean,              // official → editable=true (можно править перед применением)
  premium_pct?: number            // надбавка/дисконт к «официальному» (например, для наличного рынка)
}
```

> Для «официальных» курсов разрешаем **премию/дисконт** (например, +1.5% к mid‑курсу), чтобы приблизить к «наличному»/P2P‑рынку. Эту надбавку задаёт пользователь в настройках пары.

---

## 3) Потоки в UI (как это работает для вас)

### 3.1 Расход/Приход/Обмен

1. Пользователь выбирает валюту операции (например, **UZS**), а валюта бюджета/сводки — **USD**.
2. Поле «Курс» показывает **подсказку**:

   * «Официальный (ЦБ Узбекистана) на сегодня: **12 200 UZS/USD**» + значок «карандаш».
   * Если включена надбавка, рядом «(+1.0%) → 12 322».
3. Пользователь может:

   * **Принять** предложенный курс как есть;
   * **Отредактировать** цифру;
   * **Выбрать другой источник** (Manual/Frozen/MonthlyAvg/LastUsed).
4. В карточку операции сохраняем `fx_rate_snapshot`:

```
{
  pair: "UZS/USD",
  source: "official",
  provider: "central_bank_uz",
  proposed_rate: "12200",
  premium_applied_pct: 1.0,
  final_rate: "12322",             // то, что подтвердил пользователь
  edited: true, edited_by: user_id, edited_reason?: "cash market"
  as_of: "2025-11-13T10:05:00+05:00"
}
```

### 3.2 IOU — погашение/закрытие

* В форме «Получить платёж» поле «Курс погашения» ведёт себя так же: подставляет **официальный** (если включено), а вы **можете изменить**.
* Мини‑чек показывает: «Предложение: 12 200; Утверждённый: 12 322; Закрыто …; Остаток …; FX‑разница …».

### 3.3 Кнопка «Зафиксировать для проекта/месяца»

* Из подсказки официального курса можно в 1 тап **сделать Frozen‑курс проекта** (или **MonthlyAvg** для текущего месяца). Это ускоряет настройку бюджетной политики.

---

## 4) Логика выбора курса (псевдокод)

```ts
function proposeRate(pair, ctx) {
  // приоритеты можно менять в настройках
  if (ctx.project.frozenEnabled && existsFrozen(pair)) return frozen(pair);

  if (ctx.settings.rate_source_priority.includes('official') && online()) {
    const official = fetchOfficial(pair, ctx.region);  // с кэшем
    const withPremium = applyPremium(official, ctx.userPremiumPct[pair]);
    return { ...withPremium, source: 'official', editable: true };
  }

  if (existsMonthlyAvg(pair, ctx.month)) return monthlyAvg(pair, ctx.month);
  if (existsLastUsed(pair)) return lastUsed(pair);
  return { source: 'manual', rate: null, editable: true }; // попросим ввести руками
}

function confirmRate(userInput, proposal) {
  // всегда сохраняем снимок:
  return {
    pair: proposal.pair,
    source: proposal.source ?? 'manual',
    proposed_rate: proposal.rate,
    premium_applied_pct: proposal.premium,
    final_rate: userInput.rate,      // то, что подтвердил пользователь (может совпадать с предложением)
    edited: (userInput.rate !== proposal.rate),
    provider: proposal.provider_id,
    as_of: now()
  };
}
```

---

## 5) Кэш и офлайн

* Все официальные курсы складываем в локальный кэш (**per‑day/per‑pair**) с **временной меткой и провайдером**.
* Если пользователь офлайн — показываем **LastUsed**/Frozen/MonthlyAvg и всегда даём ввести **Manual**.
* TTL/обновление: «ежедневно» по локальному времени региона (например, 00:00–02:00). Можно обновить вручную кнопкой «Обновить курсы».

---

## 6) Разрешения и аудит

* Любое редактирование официальной подсказки фиксируем флагом `edited=true` + `edited_by` + `optional reason`.
* В отчёте/истории операции показываем: «Источник: Официальный (отредактирован пользователем)».
* Для юридической чистоты добавляем дисклеймер: «Официальные курсы приводятся для справки; итоговый расчёт — по подтверждённому пользователем значению».

---

## 7) Взаимосвязь с бюджетом и IOU

* **Бюджет**: выбор курса для пересчёта в `budget_currency` идёт по **политике проекта** (FROZEN/TRANSACTION/MONTHLY_AVG).

  * При `TRANSACTION` используем **final_rate из снимка** конкретной операции (независимо, был ли он «официальный» изначально).
  * При `FROZEN`/`MONTHLY_AVG` — берём значения, которые пользователь зафиксировал в соответствующих таблицах (могут быть скопированы из Official и отредактированы).
* **IOU**: в событиях `payment/close` используем **подтверждённый пользователем** курс. Официальная подсказка — лишь стартовая точка.

---

## 8) Настройки (что видит пользователь)

* **Регион**: Узбекистан / Казахстан / …
* **Официальный источник курсов**: вкл/выкл (по умолчанию — вкл для региона).
* **Премия к официальному** по парам (например, `UZS/USD +1.5%`).
* **Приоритет источников**: [Frozen, Manual, Official, MonthlyAvg, LastUsed] (drag‑drop).
* **Политика бюджета**: TRANSACTION / FROZEN / MONTHLY_AVG.
* **Кнопки**: «Сделать текущий официальный курс Frozen для проекта», «Обновить официальный курс сейчас».

---

## 9) Приёмочные кейсы

### 9.1 Подставили официальный → отредактировали

* Регион: Узбекистан. Официальный: `UZS/USD = 12 200`. Пользователь указал премию 1.0% → предложение `12 322`.
* В расходе на 30 000 000 UZS пользователь правит до `12 350` и сохраняет.
  **Ожидаем:** в `fx_rate_snapshot.final_rate = 12 350`, `source='official'`, `edited=true`.

### 9.2 Официальный → Frozen одним тапом

* В проекте кнопка «Зафиксировать на месяц» копирует `12 200` в таблицу `MonthlyAvg` ноября / или в `Frozen` проекта.
  **Ожидаем:** новая запись в RateBook с `source='frozen'` и ссылкой на проект/месяц.

### 9.3 Офлайн

* Интернет пропал. Пользователь делает расход в UZS для бюджета USD.
  **Ожидаем:** компонент курса предлагает `LastUsed` и поле `Manual`. Сохранение возможно **только** после ввода/подтверждения курса.

### 9.4 IOU погашение

* Долг в USD, платёж в UZS. Подставился официальный `12 200`, но пользователь задаёт `12 320`.
  **Ожидаем:** закрытие долга рассчитывается по `12 320`; в мини‑чеке явная отметка «Официальный был 12 200, применён 12 320».

---

## 10) Что делать разработчикам

**Бэкенд/Данные**

* Ввести сущность `rate_provider` (registry), таблицы `rate_cache` (official), `rate_book` (frozen/monthly_avg/manual/last_used).
* Расширить `fx_rate_snapshot` в транзакциях/IOU событиях полями: `source, provider, proposed_rate, final_rate, premium_applied_pct, edited, edited_by, as_of`.

**Интеграция**

* Сделать адаптер `OfficialProvider` с конфигом по региону (URL/парсинг/ориентация пары/временная зона).
* Кэшировать результаты; не падать при ошибках — всегда есть manual.

**Фронтенд/UX**

* Поле курса с табом источников: **Manual / Official / Frozen / MonthlyAvg / LastUsed**.
* Кнопки «Принять», «Изменить», «Сделать Frozen/MonthlyAvg».
* Мини‑чек с двумя цифрами: «Предложен» и «Применён».

---

### Коротко ответ на ваши вопросы

* **Интеграция с ЦБ Узбекистана** — да, как **опциональный провайдер** «Official» для подсказки курса.
* **Редактировать курс вручную** — да, **всегда**. Любое «официальное» значение можно **поправить**, и именно отредактированное попадёт в расчёт и в снимок операции.
* **Офлайн‑режим** — сохраняется: при отсутствии сети вы вводите курс вручную или берёте «LastUsed/Frozen/MonthlyAvg», всё работает.

Если хотите, добавлю технический шаблон адаптера `OfficialProvider` (интерфейс, кэш, нормализация пары, таймзона региона) и JSON‑схему `fx_rate_snapshot` — можно сразу отдавать в работу.
